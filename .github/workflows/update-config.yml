name: Update config with latest release exe

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  update-config:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ جلب آخر Release ونسخة الريليس والعنوان
      - name: Get latest release info
        run: |
          echo "Fetching latest release info..."
          LATEST_JSON=$(curl -s -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/Anas-jaf/almo3lem_releases/releases/latest)

          VERSION=$(echo "$LATEST_JSON" | jq -r .tag_name)
          TITLE=$(echo "$LATEST_JSON" | jq -r .name)

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "TITLE=$TITLE" >> $GITHUB_ENV

          UPDATE_URL="https://github.com/Anas-jaf/almo3lem_releases/releases/download/${VERSION}/almo3lem_setup_light.exe"
          echo "UPDATE_URL=$UPDATE_URL" >> $GITHUB_ENV
          
      # 2️⃣ عرض النسخة والعنوان في Logs
      - name: Show release version and title
        run: |
          echo "=============================="
          echo "Latest release version: $VERSION"
          echo "Release title: $TITLE"
          echo "Update URL: $UPDATE_URL"
          echo "=============================="

      # 3️⃣ نسخ مستودع الكونفيغ
      - name: Checkout config repo
        uses: actions/checkout@v4
        with:
          repository: mostafatarawneh/almo3lem-config
          token: ${{ secrets.CONFIG_REPO_TOKEN }}

      # 4️⃣ تحقق من وجود update.json
      - name: Check update.json exists
        run: |
          if [ ! -f update.json ]; then
            echo "File update.json not found!"
            exit 1
          fi

      # 5️⃣ تحديث update.json بالصيغة المطلوبة
      - name: Update update.json
        run: |
          jq -n \
            --arg version "$VERSION" \
            --arg title "$TITLE" \
            --arg url "$UPDATE_URL" \
            --arg msg "يوجد تحديث جديد يحتوي على تحسينات وأصلاحات." \
            '{latest_version: $version, title: $title, update_url: $url, message: $msg, is_active: true}' \
            > update.json

      # 6️⃣ Commit & Push التغييرات
      - name: Commit and push
        run: |
          git config user.name "almo3lem-bot"
          git config user.email "bot@users.noreply.github.com"
          git add update.json
          git commit -m "Update to latest release $VERSION ($TITLE)"
          git push
