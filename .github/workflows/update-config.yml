name: Update config with latest release

# يمكن تشغيله عند أي Release جديد أو يدوياً
on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  update-config:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ جلب آخر Release من المستودع عبر GitHub API
      - name: Get latest release info
        id: latest
        run: |
          LATEST_JSON=$(curl -s -H "Accept: application/vnd.github+json" https://api.github.com/repos/Anas-jaf/almo3lem_releases/releases/latest)
          VERSION=$(echo "$LATEST_JSON" | jq -r .tag_name)
          FILE_NAME=$(echo "$LATEST_JSON" | jq -r '.assets[0].name')
          DOWNLOAD_URL=$(echo "$LATEST_JSON" | jq -r '.assets[0].browser_download_url')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "FILE_NAME=$FILE_NAME" >> $GITHUB_ENV
          echo "DOWNLOAD_URL=$DOWNLOAD_URL" >> $GITHUB_ENV

      # 2️⃣ حساب SHA256 للملف
      - name: Compute SHA256 checksum
        run: |
          curl -L -o $FILE_NAME $DOWNLOAD_URL
          SHA256=$(sha256sum $FILE_NAME | awk '{print $1}')
          echo "SHA256=$SHA256" >> $GITHUB_ENV

      # 3️⃣ نسخ مستودع الكونفيغ
      - name: Checkout config repo
        uses: actions/checkout@v4
        with:
          repository: mostafatarawneh/almo3lem-config
          token: ${{ secrets.CONFIG_REPO_TOKEN }}

      # 4️⃣ تحقق من وجود update.json قبل التعديل
      - name: Check update.json exists
        run: |
          if [ ! -f update.json ]; then
            echo "File update.json not found!"
            exit 1
          fi

      # 5️⃣ تحديث update.json
      - name: Update update.json
        run: |
          jq \
            --arg version "$VERSION" \
            --arg url "$DOWNLOAD_URL" \
            --arg sha "$SHA256" \
            '.latest_version=$version | .download_url=$url | .sha256=$sha' \
            update.json > tmp.json
          mv tmp.json update.json

      # 6️⃣ Commit & Push التغييرات
      - name: Commit and push
        run: |
          git config user.name "almo3lem-bot"
          git config user.email "bot@users.noreply.github.com"
          git add update.json
          git commit -m "Update to latest release $VERSION"
          git push
